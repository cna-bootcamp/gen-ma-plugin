# =============================================================================
# Stage 1: Build
# =============================================================================
FROM node:20-alpine AS build

WORKDIR /app

# 의존성 설치 (캐시 최적화)
COPY package.json package-lock.json* ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/backend/package.json ./packages/backend/

RUN npm ci --workspace=packages/shared --workspace=packages/backend --include-workspace-root --force

# 소스 복사
COPY tsconfig.json ./
COPY packages/shared/ ./packages/shared/
COPY packages/backend/ ./packages/backend/

# shared 빌드 → backend 빌드
RUN npm run build -w packages/shared && npm run build -w packages/backend

# =============================================================================
# Stage 2: Runtime (production dependencies only)
# =============================================================================
FROM node:20-alpine

# node:20-alpine 내장 'node' 사용자 활용 (HOME=/home/node)
# Claude CLI 글로벌 설치 (root 권한으로 실행)
RUN npm install -g --force @anthropic-ai/claude-code && \
    claude --version || echo "claude CLI installed"

WORKDIR /app

# production 의존성만 설치
COPY package.json package-lock.json* ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/backend/package.json ./packages/backend/

RUN npm ci --workspace=packages/shared --workspace=packages/backend --include-workspace-root --force --omit=dev

# 빌드 결과물 복사
COPY --from=build /app/packages/shared/dist ./packages/shared/dist
COPY --from=build /app/packages/shared/package.json ./packages/shared/
COPY --from=build /app/packages/backend/dist ./packages/backend/dist

# shared package.json의 main을 빌드된 dist로 변경 (런타임에서 .ts 참조 방지)
RUN sed -i 's|"main": "./src/index.ts"|"main": "./dist/index.js"|' packages/shared/package.json && \
    sed -i 's|"types": "./src/index.ts"|"types": "./dist/index.d.ts"|' packages/shared/package.json

# 마운트 포인트 생성 (node 사용자 소유)
RUN mkdir -p /home/node/.claude && chown -R node:node /home/node/.claude && \
    mkdir -p /app/dmap-project && chown -R node:node /app/dmap-project && \
    chown -R node:node /app

USER node
ENV HOME=/home/node
ENV NODE_ENV=production
ENV PORT=3001

EXPOSE 3001

CMD ["node", "packages/backend/dist/server.js"]
